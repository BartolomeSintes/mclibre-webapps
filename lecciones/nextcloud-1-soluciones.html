<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Soluciones (1). Nextcloud. Aplicaciones web. Bartolomé Sintes Marco. www.mclibre.org</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../varios/webapps.css" title="mclibre" />
  <link rel="icon" href="../varios/favicon.ico" />
  <link rel="stylesheet" href="../varios/prism-webapps.css" />
  <script src="../varios/prism.js"></script>
</head>

<body>
  <h1>Nextcloud - Ejercicios (1) - Soluciones</h1>

  <nav>
    <p>
      <a href="../index.html"><img src="../varios/iconos/icono-webapps.svg" alt="Índice de WebApps" title="Índice de WebApps" width="48" height="31" /></a>
      <a href="#"><img src="../varios/iconos/icono-arrow-circle-up.svg" alt="Principio de la página" title="Principio de la página" width="36" height="36" /></a>
    </p>

    <div class="toc">
      <h2>
        <a href="nextcloud.html"><img src="../varios/iconos/icono-flecha-izquierda.svg" alt="Anterior" title="Anterior" width="15" height="18" /></a> Nextcloud (1)
        <a href="nextcloud-2.html"><img src="../varios/iconos/icono-flecha-derecha.svg" alt="Siguiente" title="Siguiente" width="15" height="18" /></a>
      </h2>

      <h3><a href="nextcloud-1.html">Enunciados</a></h3>
      <ul>
        <li><a href="nextcloud-1.html#ejercicio-1">1 - DB SQLite</a></li>
        <li><a href="nextcloud-1.html#ejercicio-2">2 - DB MariaDB</a></li>
        <li><a href="nextcloud-1.html#ejercicio-3">3 - Completar instalación</a></li>
        <li><a href="nextcloud-1.html#ejercicio-4">4 - Actualizar</a></li>
        <li><a href="nextcloud-1.html#ejercicio-5">5 - Habilitar https</a></li>
        <li><a href="nextcloud-1.html#ejercicio-6">6 - http a https</a></li>
        <li><a href="nextcloud-1.html#ejercicio-7">7 - Cambio IP</a></li>
        <li><a href="nextcloud-1.html#ejercicio-8">8 - LibreOffice</a></li>
      </ul>

      <h3><a href="#">Soluciones</a></h3>
      <ul>
        <li><a href="#ejercicio-1">1 - DB SQLite</a></li>
        <li><a href="#ejercicio-2">2 - DB MariaDB</a></li>
        <li><a href="#ejercicio-3">3 - Completar instalación</a></li>
        <li><a href="#ejercicio-4">4 - Actualizar</a></li>
        <li><a href="#ejercicio-5">5 - Habilitar https</a></li>
        <li><a href="#ejercicio-6">6 - http a https</a></li>
        <li><a href="#ejercicio-7">7 - Cambio IP</a></li>
        <li><a href="#ejercicio-8">8 - LibreOffice</a></li>
      </ul>
    </div>
  </nav>

  <p>En esta lección se proponen soluciones detalladas de los <a href="nextcloud-1.html">ejercicios (1) de Nextcloud</a>. Se recomienda intentar realizarlos primero sin recurrir a estas soluciones.</p>

  <section id="ejercicio-1">
    <h2>Nextcloud (1) 1 - Nextcloud con base de datos SQLite</h2>

    <p class="incompleto">Por escribir</p>
  </section>

  <section id="ejercicio-2">
    <h2>Nextcloud (1) 2 - Nextcloud con base de datos MariaDB</h2>
    <ol>
      <li>Las instrucciones se encuentran en el repositorio <a href="https://github.com/nextcloud/docker">https://github.com/nextcloud/docker</a>.</li>
      <li>Si va a utilizar SQLite, ejecute el comando:
        <div class="terminal">
          <pre><code class="language-shell">sudo docker run -d --name=nextcloud -p 80:80 nextcloud</code></pre>
        </div>
      </li>
      <li>Si va a utilizar MariaDB, ejecute los comandos siguientes:
        <ul>
          <li>Cree una red:
            <div class="terminal">
              <pre><code class="language-shell">sudo docker network create nc-network</code></pre>
            </div>
          </li>
          <li>Cree el contenedor de MariaDB:
            <div class="terminal">
              <pre><code class="language-shell">sudo docker run -d --name=nc-mariadb -e ALLOW_EMPTY_PASSWORD=yes --net=nc-network bitnami/mariadb</code></pre>
            </div>
          </li>
          <li>Cree el contenedor de phpMyAdmin:
            <div class="terminal">
              <pre><code class="language-shell">sudo docker run -d --name=nc-pma -e DATABASE_HOST=nc-mariadb -p 8801:80 --net=nc-network bitnami/phpmyadmin</code></pre>
            </div>
          </li>
          <li>Abra en el navegador del host la página http://AAA.BBB.CCC.DDD:8801 (usuario root sin contraseña) y con phpMyAdmin cree un usuario nextcloud, que pueda acceder desde cualquier servidor, con contraseña nextcloud y base de datos única.
            <p class="captura">
              <img src="../img/nextcloud/1-1-s-1-instalacion.png" alt="phpMyAdmin. Creción de usuario nextcloud" width="745" height="575" />
            </p>
          </li>
          <li>Cree el contenedor de Nextcloud:
            <div class="terminal">
              <pre><code class="language-shell">sudo docker run -d --name=nextcloud -p 80:80 -p 443:443 --net=nc-network nextcloud</code></pre>
            </div>
          </li>
        </ul>
      </li>
    </ol>
  </section>

  <section id="ejercicio-3">
    <h2>Nextcloud (1) 3 - Completar instalación</h2>

    <p>Si va a utilizar MariaDB:</p>

    <ul>
      <li>Consulte la dirección IP privada del servidor de bases de datos:
        <div class="terminal">
          <pre><code class="language-shell">sudo docker network inspect nc-network</code></pre>
        </div>
        <p>La dirección debe ser del tipo <span class="codigo-modificacion">172.XXX.YYY.ZZZ</span></p>
      </li>
      <li>Configure el acceso de Nextcloud a la base de datos:
        <p class="captura">
          <img src="../img/nextcloud/1-2-s-1-completar.png" alt="Nextcloud. Conexión con MariaDB" width="400" height="630" />
        </p>
      </li>
      <li>Para salir de Nextcloud, haga clic en la rueda dentada (arriba a la derecha) y seleccione la opción Desconectar:
        <p class="captura">
          <img src="../img/nextcloud/1-2-s-2-salir.png" alt="Nextcloud. Salir" width="1008" height="260" />
        </p>
      </li>
    </ul>
  </section>

  <section id="ejercicio-4">
    <h2>Nextcloud (1) 4 - Actualizar Nextcloud</h2>

    <ul>
      <li>Entre en Nextcloud como administrador. Haga clic en el icono del usuario (arriba a la derecha) y seleccione la opción Configuración:
        <p class="captura">
          <img src="../img/nextcloud/1-3-s-1-actualizar.png" alt="Nextcloud. Actualizar" width="1008" height="260" />
        </p>
      </li>
      <li>Compruebe si existe una actualización disponible:
        <p class="captura">
          <img src="../img/nextcloud/1-3-s-2-actualizar.png" alt="Nextcloud. Actualizar" width="1008" height="210" />
        </p>
        <p><strong>Nota</strong>: Actualmente (febrero de 2018), todavía no se ha publicado ninguna actualización de Nextcloud13. La versión 13.0.1 está prevista para mediados de marzo de 2018.</p>
      </li>
      <li><img src="../varios/iconos/icono-warning.svg" alt="¡Atención!" width="55" height="48" />El resto de esta solución corresponde a la versión 11. No sé si en la versión 13 se hará de la misma manera.</li>
      <li>Antes de hacer clic en el botón "Abrir el actualizador", ejecute el script que cambia los permisos:
        <div class="terminal">
          <pre><code class="language-shell">sudo docker exec -it nc sh -c 'set-nc-perms upgrade'</code></pre>
        </div>
      </li>
      <li>Haga clic en el botón "Abrir el actualizador":</li>
      <li>Haga clic en el botón "Start update":
        <p class="captura">
          <img src="../img/nextcloud/1-3-s-3-actualizar.png" alt="Nextcloud. Actualizar" width="700" height="300" />
        </p>
      </li>
      <li><img src="../varios/iconos/icono-warning.svg" alt="¡Atención!" width="55" height="48" />En mi caso no he podido realizar la actualización porque me sale el siguiente mensaje de errror:
        <p class="captura">
          <img src="../img/nextcloud/1-3-s-4-actualizar.png" alt="Nextcloud. Actualizar" width="700" height="300" />
        </p>
      </li>
      <li>Ejecute el script que restaura los permisos:
        <div class="terminal">
          <pre><code class="language-shell">sudo docker exec -it nc sh -c 'set-nc-perms runtime'</code></pre>
        </div>
      </li>
    </ul>
  </section>

  <section id="ejercicio-5">
    <h2>Nextcloud (1) 5 - Habilitar https en el servidor</h2>

    <ul>
      <li>Entre en la shell del contenedor de Nextcloud:
        <div class="terminal">
          <pre><code class="language-shell">sudo docker exec -it nextcloud /bin/bash</code></pre>
        </div>
      </li>
      <li>Actualice la lista de paquetes:
        <div class="terminal">
          <pre><code class="language-shell">apt update</code></pre>
        </div>
      </li>
      <li>Instale el paquete ssl-cert:
        <div class="terminal">
          <pre><code class="language-shell">apt install ssl-cert</code></pre>
        </div>
      </li>
      <li>Genere el certificado snakeoil:
        <div class="terminal">
          <pre><code class="language-shell">make-ssl-cert generate-default-snakeoil --force-overwrite</code></pre>
        </div>
      </li>
      <li>Active el módulo SSL de Apache:
        <div class="terminal">
          <pre><code class="language-shell">a2enmod ssl</code></pre>
        </div>
      </li>
      <li>Habilite la configuración SSL de Apache:
        <div class="terminal">
          <pre><code class="language-shell">a2ensite default-ssl</code></pre>
        </div>
      </li>
      <li>Reinicie el servicio Apache:
        <div class="terminal">
          <pre><code class="language-shell">service apache2 restart</code></pre>
        </div>
      </li>
      <li>Reinicie el contenedor de Nextcloud:
        <div class="terminal">
          <pre><code class="language-shell">sudo docker start nextcloud</code></pre>
        </div>
      </li>
    </ul>
  </section>

  <section id="ejercicio-6">
    <h2>Nextcloud (1) 6 - Acceder siempre mediante https</h2>

    <p>Para configurar el servidor Apache del contenedor de manera que fuerce conexiones seguras:</p>

    <ol>
      <li>Entre en la shell del contenedor de Nextcloud:
        <div class="terminal">
          <pre><code class="language-shell">sudo docker exec -it nextcloud /bin/bash</code></pre>
        </div>
      </li>
      <li>Busque el directorio en el que se encuentra el fichero <strong>apache2.conf</strong>:
        <div class="terminal">
          <pre><code class="language-shell">find / -name apache2.conf</code></pre>
        </div>
      </li>
      <li>Salga de la shell del contenedor de Nextcloud:
        <div class="terminal">
          <pre><code class="language-shell">exit</code></pre>
        </div>
      </li>
      <li>Copie el fichero <strong>apache2.conf</strong> del contenedor al anfitrión:
        <div class="terminal">
          <pre><code class="language-shell">sudo docker cp nextcloud:/etc/apache2/apache2.conf /tmp/apache2.conf</code></pre>
        </div>
      </li>
      <li>Haga una copia de seguridad del fichero original:
        <div class="terminal">
          <pre><code class="language-shell">sudo cp /tmp/apache2.conf /tmp/apache2.conf.original</code></pre>
        </div>
      </li>
      <li>Edite el fichero de configuración:
        <div class="terminal">
          <pre><code class="language-shell">sudo vi /tmp/apache2.conf</code></pre>
        </div>
      </li>
      <li>Añada en el fichero de configuración una directiva VirtualHost que redirija las peticiones http a https, en la que AAA.BBB.CCC.DDD es la IP de la máquina virtual:
        <div class="codigo">
          <pre>
<code class="language-configuracion">&lt;VirtualHost *:80&gt;
  Servername <span class="codigo-modificacion">AAA.BBB.CCC.DDD</span>
  Redirect permanent / https://<span class="codigo-modificacion">AAA.BBB.CCC.DDD</span>/
&lt;/VirtualHost&gt;</code>
</pre>
        </div>
        <p><strong>Nota</strong>: Creo que el valor de Servername no es importante, pero debe haber Servername.</p>
      </li>
      <li>Guarde el fichero de configuración modificado.</li>
      <li>Copie el fichero <strong>apache2.conf</strong> del anfitrión al contenedor:
        <div class="terminal">
          <pre><code class="language-shell">sudo docker cp /tmp/apache2:conf nextcloud:/etc/apache2/apache2.conf</code></pre>
        </div>
      </li>
      <li>Entre de nuevo en la shell del contenedor de Nextcloud:
        <div class="terminal">
          <pre><code class="language-shell">sudo docker exec -it nextcloud /bin/bash</code></pre>
        </div>
      </li>
      <li>Reinicie el servicio Apache:
        <div class="terminal">
          <pre><code class="language-shell">service apache2 restart</code></pre>
        </div>
      </li>
      <li>Reinicie el contenedor
        <div class="terminal">
          <pre><code class="language-shell">sudo docker start nextcloud</code></pre>
        </div>
      </li>
    </ol>
  </section>

  <section id="ejercicio-7">
    <h2>Nextcloud (1) 7 - Cambio de IP</h2>

    <p>Para cambiar la IP de la máquina virtual:</p>

    <ol>
      <li>Consulte la dirección IP de la máquina virtual:
        <div class="terminal">
          <pre><code class="language-shell">ip addr</code></pre>
        </div>
      </li>
      <li>Consulte la dirección IP de la puerta de enlace (pasarela, <i>gateway</i>):
        <div class="terminal">
          <pre><code class="language-shell">route -n</code></pre>
        </div>
      </li>
      <li>Edite el archivo /etc/network/interfaces:
        <div class="terminal">
          <pre><code class="language-shell">sudo vi /etc/network/interfaces</code></pre>
        </div>
      </li>
      <li>Establezca un IP fija distinta a la anterior. Por ejemplo, cambie la configuración de IP de dinámica ...:
        <div class="codigo">
          <pre>
<code class="language-shell"># The primary network interface
auto enp0s3
iface enp0s3 inet dhcp</code></pre>
        </div>
        <p>... a fija:</p>
        <div class="codigo">
          <pre>
<code class="language-shell"># The primary network interface
auto enp0s3
#iface enp0s3 inet dhcp
iface enp0s3 inet static
  address <span class="codigo-modificacion">192.168.1.16</span>
  netmask 255.255.255.0
  gateway <span class="codigo-modificacion">192.168.1.1</span>
dns-nameservers 8.8.8.8</code></pre>
        </div>
      </li>
    </ol>

    <p>Para modificar el valor de la IP en el archivo apache2.conf, siga los pasos explicados en el <a href="#ejercicio-5">ejercicio 5</a>.</p>
  </section>

  <section id="ejercicio-8">
    <h2>Nextcloud (1) 8 - LibreOffice en Nextcloud</h2>

    <p class="incompleto">Por escribir</p>
  </section>

  <footer>
    <p class="ultmod">Última modificación de esta página: 5 de febrero de 2019</p>

    <p class="licencia">
      <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/deed.es_ES"><img src="../varios/iconos/icono-cc-by-sa.svg" alt="Licencia Creative Commons" title="Licencia Creative Commons BY-SA" width="120" height="42" /></a><br />
      Esta página forma parte del curso <strong><a href="http://www.mclibre.org/consultar/webapps/">Aplicaciones web</a></strong> por <a href="http://www.mclibre.org/" rel="author">Bartolomé Sintes Marco</a><br />
      que se distribuye bajo una <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/deed.es_ES">Licencia Creative Commons Reconocimiento-CompartirIgual 4.0 Internacional (CC BY-SA 4.0)</a>.
    </p>
  </footer>
</body>
</html>
