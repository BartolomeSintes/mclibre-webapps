<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Ansible. Aplicaciones web. Bartolomé Sintes Marco</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="../varios/webapps.css" rel="stylesheet" type="text/css" title="mclibre" />
  <link rel="icon" href="../varios/favicon.ico" />
  <link rel="stylesheet" href="../varios/prism.css" />
  <script src="../varios/prism.js"></script>
</head>

<body>
  <h1>Ansible</h1>

  <nav>
    <p>
      <a href="../index.html"><img src="../varios/iconos/icono-webapps.svg" alt="Índice de WebApps" title="Índice de WebApps" width="48" height="31" /></a>
      <a href="#"><img src="../varios/iconos/icono-arrow-circle-up.svg" alt="Principio de la página" title="Principio de la página" width="36" height="36" /></a>
    </p>

    <div class="toc">
      <h2>
        <a href="ubuntu-instalacion.html"><img src="../varios/iconos/icono-flecha-izquierda.svg" alt="Anterior" title="Anterior" width="15" height="18" /></a> Ansible
      </h2>

      <ul>
        <li><a href="#que-es">Qué es</a></li>
        <li><a href="#ejemplos">Puesta en marcha</a>
          <ol>
            <li><a href="#instalacion-maquina-control">Máquina de control</a></li>
            <li><a href="#instalacion-nodos">Nodos administrados</a></li>
            <li><a href="#configuracion-inicial">Configuración inicial</a></li>
          </ol>
        </li>
        <li><a href="#playbooks">Playbooks</a>
          <ol>
            <li><a href="#playbook-shell">Comandos de shell</a></li>
          </ol>
        </li>
      </ul>
    </div>
  </nav>

  <p class="incompleto"><img src="../varios/iconos/icono-en-construccion.svg" alt="En construcción" width="55" height="48" />Esta lección está en elaboración</p>

  <p>Esta lección es una introducción al uso de Ansible, la herramienta de automatización de Red Hat. Como ejemplo, ... </p>

  <section id="que-es">
    <h2>Qué es Ansible</h2>

    <p><a href="https://www.ansible.com/">Ansible</a> es una herramienta de administración automatizada de ordenadores, creada por <a href="https://michaeldehaan.net/">Michael DeHaan</a> en 2012. La primera versión se publicó en marzo de 2012 y la versión 1.0 se publicó en febrero de 2013. RedHat compró Ansible en octubre de 2015.</p>

    <p class="mcl-centrado">
      <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="1050" viewBox="-50 -60 1050 100">
        <line x1="35" y1="0" x2="1000" y2="0" stroke-width="3" stroke="hsl(0, 100%, 40%)" />
        <text x="-30" y="4" text-anchor="start" style="font-size: 100%">Ansible</text>
        <text x="-10" y="-50" text-anchor="middle" style="font-size: 60%">Actualizado</text>
        <text x="-10" y="-38" text-anchor="middle" style="font-size: 60%">08-05-2018</text>

        <line x1="60" y1="-30" x2="60" y2="30" stroke-width="1" stroke-dasharray="5,5" stroke="black" />
        <text x="110" y="-40" text-anchor="middle" style="font-size: 80%">2012</text>
        <line x1="160" y1="-30" x2="160" y2="30" stroke-width="1" stroke-dasharray="5,5" stroke="black" />
        <text x="210" y="-40" text-anchor="middle" style="font-size: 80%">2013</text>
        <line x1="260" y1="-30" x2="260" y2="30" stroke-width="1" stroke-dasharray="5,5" stroke="black" />
        <text x="310" y="-40" text-anchor="middle" style="font-size: 80%">2014</text>
        <line x1="360" y1="-30" x2="360" y2="30" stroke-width="1" stroke-dasharray="5,5" stroke="black" />
        <text x="410" y="-40" text-anchor="middle" style="font-size: 80%">2015</text>
        <line x1="460" y1="-30" x2="460" y2="30" stroke-width="1" stroke-dasharray="5,5" stroke="black" />
        <text x="510" y="-40" text-anchor="middle" style="font-size: 80%">2016</text>
        <line x1="560" y1="-30" x2="560" y2="30" stroke-width="1" stroke-dasharray="5,5" stroke="black" />
        <text x="610" y="-40" text-anchor="middle" style="font-size: 80%">2017</text>
        <line x1="660" y1="-30" x2="660" y2="30" stroke-width="1" stroke-dasharray="5,5" stroke="black" />
        <text x="710" y="-40" text-anchor="middle" style="font-size: 80%">2018</text>
        <line x1="760" y1="-30" x2="760" y2="30" stroke-width="1" stroke-dasharray="5,5" stroke="black" />

        <circle cx="78" cy="0" r="5" fill="hsl(0, 100%, 40%)" />
        <text x="78" y="-15" text-anchor="middle" fill="hsl(0, 100%, 40%)" style="font-size: 80%; font-weight: bold">0.1</text>
        <circle cx="111" cy="0" r="5" fill="hsl(0, 100%, 40%)" />
        <text x="111" y="-15" text-anchor="middle" fill="hsl(0, 100%, 40%)" style="font-size: 80%; font-weight: bold">0.5</text>
        <circle cx="169" cy="0" r="5" fill="hsl(0, 100%, 40%)" />
        <text x="169" y="-15" text-anchor="middle" fill="hsl(0, 100%, 40%)" style="font-size: 80%; font-weight: bold">1.0</text>
        <circle cx="185" cy="0" r="5" fill="hsl(0, 100%, 40%)" />
        <text x="185" y="25" text-anchor="middle" fill="hsl(0, 100%, 40%)" style="font-size: 80%; font-weight: bold">1.1</text>
        <circle cx="204" cy="0" r="5" fill="hsl(0, 100%, 40%)" />
        <text x="204" y="-15" text-anchor="middle" fill="hsl(0, 100%, 40%)" style="font-size: 80%; font-weight: bold">1.2</text>
        <circle cx="230" cy="0" r="5" fill="hsl(0, 100%, 40%)" />
        <text x="230" y="25" text-anchor="middle" fill="hsl(0, 100%, 40%)" style="font-size: 80%; font-weight: bold">1.3</text>
        <circle cx="249" cy="0" r="5" fill="hsl(0, 100%, 40%)" />
        <text x="249" y="-15" text-anchor="middle" fill="hsl(0, 100%, 40%)" style="font-size: 80%; font-weight: bold">1.4</text>
        <circle cx="276" cy="0" r="5" fill="hsl(0, 100%, 40%)" />
        <text x="276" y="25" text-anchor="middle" fill="hsl(0, 100%, 40%)" style="font-size: 80%; font-weight: bold">1.5</text>
        <circle cx="294" cy="0" r="5" fill="hsl(0, 100%, 40%)" />
        <text x="294" y="-15" text-anchor="middle" fill="hsl(0, 100%, 40%)" style="font-size: 80%; font-weight: bold">1.6</text>
        <circle cx="320" cy="0" r="5" fill="hsl(0, 100%, 40%)" />
        <text x="320" y="-15" text-anchor="middle" fill="hsl(0, 100%, 40%)" style="font-size: 80%; font-weight: bold">1.7</text>
        <circle cx="350" cy="0" r="5" fill="hsl(0, 100%, 40%)" />
        <text x="350" y="-15" text-anchor="middle" fill="hsl(0, 100%, 40%)" style="font-size: 80%; font-weight: bold">1.8</text>
        <circle cx="383" cy="0" r="5" fill="hsl(0, 100%, 40%)" />
        <text x="383" y="-15" text-anchor="middle" fill="hsl(0, 100%, 40%)" style="font-size: 80%; font-weight: bold">1.9</text>
        <circle cx="463" cy="0" r="5" fill="hsl(0, 100%, 40%)" />
        <text x="463" y="-15" text-anchor="middle" fill="hsl(0, 100%, 40%)" style="font-size: 80%; font-weight: bold">2.0</text>
        <circle cx="500" cy="0" r="5" fill="hsl(0, 100%, 40%)" />
        <text x="500" y="-15" text-anchor="middle" fill="hsl(0, 100%, 40%)" style="font-size: 80%; font-weight: bold">2.1</text>
        <circle cx="544" cy="0" r="5" fill="hsl(0, 100%, 40%)" />
        <text x="544" y="-15" text-anchor="middle" fill="hsl(0, 100%, 40%)" style="font-size: 80%; font-weight: bold">2.2</text>
        <circle cx="588" cy="0" r="5" fill="hsl(0, 100%, 40%)" />
        <text x="588" y="-15" text-anchor="middle" fill="hsl(0, 100%, 40%)" style="font-size: 80%; font-weight: bold">2.3</text>
        <circle cx="632" cy="0" r="5" fill="hsl(0, 100%, 40%)" />
        <text x="632" y="-15" text-anchor="middle" fill="hsl(0, 100%, 40%)" style="font-size: 80%; font-weight: bold">2.4</text>
        <circle cx="683" cy="0" r="5" fill="hsl(0, 100%, 40%)" />
        <text x="683" y="-15" text-anchor="middle" fill="hsl(0, 100%, 40%)" style="font-size: 80%; font-weight: bold">2.5</text>
        <circle cx="714" cy="0" r="5" fill="white" stroke="hsl(0, 100%, 40%)" />
        <text x="714" y="-15" text-anchor="middle" fill="hsl(0, 100%, 40%)" style="font-size: 80%; font-weight: bold">2.6</text>
      </svg>
    </p>

    <hr class="corta" />

    <p>Con Ansible, un ordenador es la <strong>máquina de control</strong> (<i>control machine</i>) y el resto de ordenadores son los <strong>nodos administrados</strong> (<i>managed nodes</i>).</p>

    <p>En la máquina de control es donde se instala Ansible. En los nodos administrados no es necesario instalar ningún software. El acceso de la máquina de control a los nodos administrados se hace normalmente mediante conexiones SSH.</p>
  </section>

  <section id="puesta-en-marcha">
    <h2>Puesta en marcha</h2>

    <p>En los tres apartados siguientes:</p>
    <ul>
      <li>se crea una máquina virtual con Ubuntu 18.03 Server que actuará como máquina de control</li>
      <li>se crea una o varias máquinas virtuales con Ubuntu 18.04 Server que actuará(n) como nodos administrados</li>
      <li>se configura la máquina de control para que Ansible pueda acceder a los nodos administrados</li>
    </ul>

    <section id="instalacion-maquina-control">
      <h3>Máquina de control: instalación de Ansible en Ubuntu 18.04</h3>

      <p>Instalaremos Ansible en una máquina virtual de VirtualBox con Ubuntu 18.04 Server que ejercerá de máquina de control. La instalación la realizaremos con Packer a partir de la imagen creada en el <a href="#creacion-vm-vbox-ubuntu">ejemplo 1 de la lección de Packer</a> mediante la plantilla y script siguientes:</p>

      <ul>
        <li>Plantilla de Packer <strong>ansible-1-1.json</strong>:

          <div class="codigo">
            <pre class="line-numbers">
<code class="language-json">{
  "builders": [
    {
      "type": "virtualbox-ovf",
      "source_path": "<span class="codigo-resaltado">packer-1-1/packer-1-1-ubuntu-18-04-server.ova</span>",
      "guest_additions_mode": "disable",
      "boot_wait": "30s",
      "ssh_username": "<span class="codigo-resaltado">barto</span>",
      "ssh_password": "<span class="codigo-resaltado">barto</span>",
      "shutdown_command": "echo '<span class="codigo-resaltado">barto</span>' | sudo -S shutdown -P now",
      "post_shutdown_delay": "120s",
      "vboxmanage_post": [
        ["modifyvm", "{{.Name}}", "--nic1", "bridged"],
        ["modifyvm", "{{.Name}}", "--bridgeadapter1", "<span class="codigo-resaltado">Realtek PCIe GBE Family Controller</span>"]
      ],
      "output_directory": "<span class="codigo-resaltado">ansible-1-1</span>",
      "vm_name": "<span class="codigo-resaltado">ansible-1-1-control</span>",
      "format": "ova"
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "execute_command": "echo '<span class="codigo-resaltado">barto</span>' | sudo -S sh -c '{{ .Vars }} {{ .Path }}'",
      "script": "<span class="codigo-resaltado">ansible-1-1.sh</span>",
      "pause_before": "10s"
    }
  ]
}</code>
</pre>
          </div>

          <p>Notas:</p>
          <ul>
            <li>Línea 11: El retardo tras el apagado es para dar tiempo a VirtualBox a desbloquear la máquina y poder hacer la exportación final.</li>
          </ul>
        </li>
        <li><i>script</i> de instalación de Ansible <strong>ansible-1-1.sh</strong> [<a href="http://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html#latest-releases-via-apt-ubuntu">fuente</a>]:

          <div class="codigo">
            <pre class="line-numbers">
<code class="language-bash">sudo apt-get update
sudo apt-get upgrade -y
sudo apt-get install software-properties-common
sudo apt-add-repository -y ppa:ansible/ansible
sudo apt-get update
sudo apt-get install -y ansible</code>
</pre>
          </div>
        </li>
      </ul>
    </section>

    <section id="instalacion-nodos">
      <h3>Nodos administrados: Ubuntu 18.04</h3>

      <p>En los nodos administrados no es necesario instalar Ansible. Los nodos administrados serán también máquinas virtuales de VirtualBox con Ubuntu 18.04 Server. La instalación la realizaremos con Packer a partir de la imagen creada en el <a href="#creacion-vm-vbox-ubuntu">ejemplo 1 de la lección de Packer</a> mediante la plantilla siguiente. En caso de querer crear otros nodos administrados, deberíamos cambiar el directorio de salida y el nombre de la máquina virtual (líneas 16 y 17) y ejecutar de nuevo la plantilla.</p>

      <ul>
        <li>Plantilla de Packer <strong>ansible-1-2.json</strong>:

          <div class="codigo">
            <pre class="line-numbers">
<code class="language-json">{
  "builders": [
    {
      "type": "virtualbox-ovf",
      "source_path": "<span class="codigo-resaltado">packer-1-1/packer-1-1-ubuntu-18-04-server.ova</span>",
      "guest_additions_mode": "disable",
      "boot_wait": "30s",
      "ssh_username": "<span class="codigo-resaltado">barto</span>",
      "ssh_password": "<span class="codigo-resaltado">barto</span>",
      "shutdown_command": "echo '<span class="codigo-resaltado">barto</span>' | sudo -S shutdown -P now",
      "post_shutdown_delay": "120s",
      "vboxmanage_post": [
        ["modifyvm", "{{.Name}}", "--nic1", "bridged"],
        ["modifyvm", "{{.Name}}", "--bridgeadapter1", "<span class="codigo-resaltado">Realtek PCIe GBE Family Controller</span>"]
      ],
      "output_directory": "<span class="codigo-resaltado">ansible-1-2-1</span>",
      "vm_name": "<span class="codigo-resaltado">ansible-1-2-nodo-1</span>",
      "format": "ova"
    }
  ]
}</code>
</pre>
          </div>

          <p>Notas:</p>
          <ul>
            <li>Línea 11: El retardo tras el apagado es para dar tiempo a VirtualBox a desbloquear la máquina y poder hacer la exportación final.</li>
          </ul>
        </li>
      </ul>
    </section>

    <section id="configuracion-inicial">
      <h3>Configuración inicial y primera conexión</h3>

      <p>La máquina de control Ansible se conecta con los nodos administrados por SSH. Para poder realizar esa conexión y comprobar su correcto funcionamiento, realice estos pasos en la máquina de cotnrol:</p>

      <ul>
        <li>Edite el archivo <strong>/etc/ansible/hosts</strong> para añadir la dirección IP de los nodos administrados:

          <div class="codigo">
            <pre>
<code class="language-shell">sudo nano /etc/ansible/hosts</code>
</pre>
          </div>
        </li>
        <li>En el archivo <strong>/etc/ansible/hosts</strong> Ansible permite crear grupos de nodos. Los nombre de los grupos se escriben entre corchetes ([XXX]).

          <p>Las opciones de configuración se pueden escribir en grupo [XXX-vars] (y afectan a todos los nodos incluidos en el grupo:</p>

          <div class="codigo">
            <pre>
<code class="language-configuracion">[clients]
<span class="codigo-resaltado">192.168.1.16</span>

[clients:vars]
ansible_python_interpreter=/usr/bin/python3</code>
</pre>
          </div>
          <p>Notas:</p>
          <ul>
            <li>Como Ubuntu 18.04 incluye Python 3 (pero no Python 2), es necesario indicar a Ansible que utilice python3..
            </li>
          </ul>

          <p>Las opciones de configuración se pueden escribir en cada nodo (y afectan únicamente a dicho nodo):</p>

          <div class="codigo">
            <pre>
<code class="language-configuracion">[clients]
<span class="codigo-resaltado">192.168.1.16</span> ansible_python_interpreter=/usr/bin/python3</code>
</pre>
          </div>
        </li>

        <li>Ansible se comunica con los nodos mediante SSH por lo que se debe crear una clave SSH en la máquina de control y enviarla a los nodos administrados:
          <div class="codigo">
            <pre>
<code class="language-shell">ssh-keygen -t rsa
ssh-copy-id <span class="codigo-resaltado">barto@192.168.1.16</span></code>
</pre>
          </div>
        </li>

        <li>Compruebe que se puede conectar con los nodos mediante la orden:

          <div class="codigo">
            <pre>
<code class="language-shell">ansible all -m ping</code>
</pre>
          </div>

          <p>Por cada nodo administrado debe mostrarse una respuesta similar a esta:</p>
          <div class="codigo">
            <pre>
<code class="">192.168.1.16 | SUCCESS =&gt; {
    "changed": false,
    "ping": "pong"
}</code>
</pre>
          </div>
        </li>
      </ul>
    </section>
  </section>

  <section id="playbooks">
    <p>Ansible trabaja mediante playboooks. Los playbooks son ficheros YAML que describen las operaciones a realizar sobre los nodos administrados.</p>

    <section id="playbook-shell">
      <h3>Ejemplo 1: Ejecución de comandos de shell</h3>

      <p>Para ejecutar comandos de la <i>shell</i>, Ansible dispone del módulo <a href="http://docs.ansible.com/ansible/latest/modules/shell_module.html">shell</a>.</p>

      <ul>
        <li>Cree el archivo <strong>playbook-1-1.yaml</strong> con el siguiente contenido:
          <div class="codigo">
            <pre>
<code class="language-yaml">---
- hosts: clients
  tasks:
  - name: ejemplo 1
    shell: ls -al &gt;&gt; prueba.txt</code>
</pre>
          </div>
        </li>
        <li>Ejecute el archivo <strong>playbook-1-1.yaml</strong>:
          <div class="codigo">
            <pre>
<code class="language-shell">ansible-playbook playbook-1-1.yaml</code>
</pre>
          </div>
        </li>

        <li>Obtendrá una respuesta similar a esta:
          <div class="codigo">
            <pre>
<code class="language-shell">PLAY [clients] ******************************************************************

TASK [Gathering facts] **********************************************************
ok: [192.168.1.16]

TASK [ejemplo 1] ****************************************************************
changed: [192.168.1.16]

PLAY RECAP **********************************************************************
192.168.1.16                 : ok=2     changed=1   unreachable=0    failed=0</code>
</pre>
          </div>
        </li>

        <li>En el nodo administrado puede comprobar que se ha creado el fichero listado.txt con el listado del directorio.</li>

        <li>Para obtener más información sobre la ejecución del playbook, ejecute el archivo con la opción --verbose:
          <div class="codigo">
            <pre>
<code class="language-shell">ansible-playbook playbook-1-1.yaml --verbose</code>
</pre>
          </div>
        </li>
      </ul>
    </section>

    <section id="playbook-apt-1">
      <h3>Ejemplo 2: Actualización del sistema</h3>

      <p>Para tareas de mantenimiento de paquetes, Ansible dispone del módulo <a href="http://docs.ansible.com/ansible/latest/modules/apt_module.html">apt</a>.</p>

      <ul>
        <li>Cree el archivo <strong>playbook-1-2.yaml</strong> con el siguiente contenido:
          <div class="codigo">
            <pre>
<code class="language-yaml">---
- hosts: clients
  tasks:
  - name: ejemplo 2
    become: yes
    apt:
      update_cache: yes
      upgrade: yes</code>
</pre>
          </div>
        </li>
        <li>Ejecute el archivo <strong>playbook-1-2.yaml</strong> con la opción -K. La opción -K es necesaria porque apt requiere la contraseña del usuario:
          <div class="codigo">
            <pre>
<code class="language-shell">ansible-playbook playbook-1-2.yaml -K</code>
</pre>
          </div>
        </li>

        <li>Obtendrá una respuesta similar a esta:
          <div class="codigo">
            <pre>
<code class="language-shell">SUDO password:

PLAY [clients] ******************************************************************

TASK [Gathering facts] **********************************************************
ok: [192.168.1.16]

TASK [ejemplo 2] ****************************************************************
[WARNING]: Could not find aptitude. Using apt-get instead.
changed: [192.168.1.16]

PLAY RECAP **********************************************************************
192.168.1.16                 : ok=2     changed=1   unreachable=0    failed=0</code>
</pre>
          </div>
          <p>Nota:</p>
          <ul>
            <li>El aviso [WARNING] se debe a que el paquete aptitude no está instalado.</li>
          </ul>
        </li>
      </ul>
    </section>

    <section id="playbook-apt-2">
      <h3>Ejemplo 3: Instalación y desinstalación de un paquete</h3>

      <p>Para tareas de mantenimiento de paquetes, Ansible dispone del módulo <a href="http://docs.ansible.com/ansible/latest/modules/apt_module.html">apt</a>.</p>

      <p>En el ejemplo siguiente, se instala el paquete <a href="https://help.ubuntu.com/lts/serverguide/aptitude.html.en">aptitude</a>, un interfaz en modo texto de APT.</p>

      <ul>
        <li>Compruebe en el nodo administrado que el paquete aptitude no está instalado con la orden:
          <div class="codigo">
            <pre>
<code class="language-shell">apt-cache policy aptitude</code>
</pre>
          </div>
          <p>Si aptitude no está instalado, se mostrará la respuesta:</p>
          <div class="codigo">
            <pre>
<code class="language-shell">aptitude:
  Instalados: (ninguno)
  ...</code>
</pre>
          </div>
        </li>
        <li>Cree el archivo <strong>playbook-1-3.yaml</strong> con el siguiente contenido:
          <div class="codigo">
            <pre>
  <code class="language-yaml">---
- hosts: clients
  tasks:
  - name: ejemplo 3
    become: yes
    apt:
      name: aptitude
      state: present</code>
</pre>
          </div>
        </li>
        <li>Ejecute el archivo <strong>playbook-1-3.yaml</strong> con la opción -K. La opción -K es necesaria porque apt requiere la contraseña del usuario:
          <div class="codigo">
            <pre>
<code class="language-shell">ansible-playbook playbook-1-3.yaml -K</code>
</pre>
          </div>
        </li>

        <li>Compruebe en el nodo administrado que el paquete aptitude sí que está ahora instalado con la orden:
          <div class="codigo">
            <pre>
<code class="language-shell">apt-cache policy aptitude</code>
</pre>
          </div>
          <p>Si aptitude está instalado, se mostrará una respuesta similar a esta:</p>
          <div class="codigo">
            <pre>
<code class="language-shell">aptitude:
  Instalados: 0.8.10-6ubuntu1
  ...</code>
</pre>
          </div>
        </li>
      </ul>

      <p>Para desinstalar el paquete, el playbook sería:</p>
      <div class="codigo">
        <pre>
<code class="language-yaml">---
- hosts: clients
tasks:
- name: ejemplo 3
become: yes
apt:
  name: aptitude
  state: absent</code>
</pre>
      </div>
    </section>
  </section>

  <footer>
    <p class="ultmod">Última modificación de esta página: 15 de mayo de 2018</p>

    <p class="licencia"><a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/deed.es_ES"><img src="../varios/iconos/icono-cc-by-sa.svg" alt="Licencia Creative Commons" title="Licencia Creative Commons BY-SA" width="120" height="42" /></a><br />
      Esta página forma parte del curso <strong><a href="http://www.mclibre.org/consultar/webapps/">Aplicaciones web</a></strong> por <a href="http://www.mclibre.org/" rel="author">Bartolomé Sintes Marco</a><br />
      que se distribuye bajo una <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/deed.es_ES">Licencia Creative Commons BY-SA 4.0</a>.</p>
  </footer>
</body>
</html>
